from sklearn.metrics.pairwise import cosine_similarity
from app import app, db
from models import Opportunity
import numpy as np

def ranker(vector):
    """
    This function performs a similarity search on the embeddings in the database and returns the 25 most similar opportunities.
    
    Args:
        vector (numpy array): The vector to compare against the embeddings in the database.
        
    Returns:
        list: A list of the 25 most similar opportunities.
    """
    with app.app_context():
        # Fetch all opportunities at once
        opportunities = Opportunity.query.all()
        
        # Ensure the input vector is a numpy array
        if not isinstance(vector, np.ndarray):
            vector = np.array(vector)

        top_opportunities = []

        # Calculate cosine similarity with each opportunity's embedding_vector
        for opportunity in opportunities:
            if opportunity.embedding_vector:
                opp_vector = np.array(opportunity.embedding_vector)
                if vector.shape[0] == opp_vector.shape[0]:  # Ensure dimensions match
                    similarity = cosine_similarity([vector], [opp_vector])[0][0]
                    top_opportunities.append((opportunity, similarity))

    # Sort by similarity (descending)
    top_opportunities.sort(key=lambda x: x[1], reverse=True)

    # Return top 25 similar opportunities
    return top_opportunities[:25]


if __name__ == "__main__":
    # Example usage
    vector = [0.030185241252183914, 0.0683843344449997, -0.03164591267704964, 0.015217556618154049, -0.020654788240790367, 0.027024060487747192, -0.016229091212153435, 0.021109025925397873, -0.06267362833023071, -0.03290662169456482, 0.0054951924830675125, 0.005662017967551947, 0.05290193483233452, 0.04509328305721283, -0.017830979079008102, -0.035137370228767395, 0.0037305557634681463, 0.024774398654699326, -0.004800379276275635, 0.0040799290873110294, -0.04288186877965927, 0.05702199041843414, -0.08433998376131058, -0.006962365470826626, -0.016977157443761826, -0.026026727631688118, -0.024133475497364998, 0.0030657751485705376, 0.03240141272544861, -0.04713505879044533, 0.055538076907396317, 0.010337293148040771, -0.05880376324057579, -0.07904036343097687, 2.810231308103539e-06, -0.05076969414949417, -0.037627581506967545, -0.00025280480622313917, -0.02943243272602558, 0.05458969995379448, 0.042059481143951416, 0.04385078325867653, -0.06232539191842079, 0.0022917890455573797, -0.010151577182114124, -0.01798338070511818, -0.007116153370589018, -0.007119292858988047, -0.008668028749525547, -0.011916796676814556, 0.014677162282168865, -0.04729852452874184, 0.014579256065189838, -0.06708644330501556, -0.046082817018032074, 0.01799016445875168, 0.01732933148741722, -0.07329324632883072, 0.010257914662361145, 0.049992576241493225, -0.01838212087750435, -0.009244740940630436, -0.035526204854249954, -0.06095956265926361, 0.07254134863615036, 0.04057438671588898, 0.0066323913633823395, -0.01574235036969185, 0.014751886948943138, -0.02363123744726181, 0.13604792952537537, 0.0469299778342247, 0.035611074417829514, 0.08079509437084198, -0.0226653590798378, -0.013307610526680946, -0.019300853833556175, 0.029488854110240936, -0.006624829955399036, -0.014532016590237617, 0.0011799089843407273, 0.0307387113571167, -0.0429920069873333, 0.029360055923461914, 0.06875788420438766, -0.036043230444192886, -0.019461560994386673, 0.014439655467867851, -0.04323476552963257, 0.023756027221679688, 0.0012528658844530582, -0.03432410955429077, -0.024067707359790802, -0.007714939769357443, 0.02527250349521637, -0.01864532381296158, -0.01486220583319664, -0.02551252394914627, -3.284995545982383e-05, 0.090193010866642, -0.015683293342590332, 0.011955768801271915, 0.02247394062578678, 0.01826801709830761, 0.015585352666676044, 0.02139151282608509, 0.007363635115325451, 0.008299737237393856, -0.02552572637796402, 0.08322715014219284, -0.048109423369169235, 0.05527803674340248, -0.02607404813170433, -0.004965650383383036, -0.017314363270998, 0.011423247866332531, -0.04578736424446106, -0.037631962448358536, -0.0440739169716835, 0.046868957579135895, 0.001168040675111115, 0.011712586507201195, -0.008657307364046574, 0.058150000870227814, -0.05714994668960571, 0.03235916048288345, 0.0002464752469677478, 0.006866545882076025, -0.005039098206907511, 0.013722841627895832, -0.03148975968360901, 0.01953311264514923, 0.01250031404197216, -0.02281532622873783, -0.011348783038556576, -0.029005518183112144, 0.05752217769622803, 0.030646981671452522, 0.0017986614257097244, -0.031732555478811264, 0.025801880285143852, 0.004230876453220844, 0.008312135934829712, -0.010854537598788738, -0.017346719279885292, -0.010039901360869408, 0.03413495048880577, 0.044006552547216415, 0.009537328965961933, -0.04201715439558029, -0.03292642906308174, -0.017477495595812798, -0.005707259755581617, -0.008213180117309093, 0.06593198329210281, 0.029211048036813736, 0.055446039885282516, -0.01330553088337183, -0.001967111835256219, 0.02395268902182579, 0.018657445907592773, -0.019550198689103127, -0.06060146912932396, -0.010286184959113598, -0.0024537367280572653, 0.034060679376125336, 0.05739104002714157, 0.02363339066505432, -0.011199434287846088, 0.00986183900386095, -0.02896690182387829, -0.006925719790160656, -0.023152025416493416, 0.05150332301855087, -0.028363369405269623, 0.11165881156921387, 0.01656084880232811, -0.04427299648523331, -0.04213910177350044, 0.011628826148808002, 0.012984842993319035, -0.17310313880443573, -0.01776864193379879, 0.0005761139909736812, -0.00974157452583313, 0.015011603012681007, 0.03204226866364479, 0.015041014179587364, -0.008884578943252563, -0.031085411086678505, -0.010123206302523613, 0.033469464629888535, -0.05080588534474373, 0.0009204692323692143, -0.0008375033503398299, -0.02771802619099617, -0.0007708239718340337, -0.014103679917752743, -0.009104433469474316, 0.03776934742927551, 0.053044553846120834, -0.036957576870918274, 0.03558459132909775, 0.08416292816400528, 0.01318275835365057, -0.018661493435502052, 0.027852648869156837, -0.050319064408540726, 0.009763265028595924, 0.03491511940956116, 0.06065927445888519, 0.010674187913537025, 0.035070281475782394, 0.05290466919541359, -0.006052362732589245, 0.013217683881521225, 0.03489669784903526, 0.019896484911441803, 0.021501822397112846, 0.059220630675554276, 0.0009216974140144885, 0.029705744236707687, 0.023250602185726166, 0.017971662804484367, -0.022594282403588295, -0.020193563774228096, -0.006115554831922054, -0.01119493693113327, 0.020663168281316757, 0.03644508123397827, -0.0001000540069071576, -0.012038258835673332, 0.00411967234686017, 0.029096707701683044, 0.0076998816803097725, -0.05356541648507118, 0.06494707614183426, -0.010706689208745956, -0.018905511125922203, -0.005697730928659439, 0.004233282059431076, -0.006468174513429403, 0.0005740553606301546, 0.017699304968118668, 0.09310291707515717, 0.007778100203722715, 0.04351472482085228, 0.013036593794822693, 0.029273895546793938, 0.004781836178153753, -0.002460057381540537, 0.031092148274183273, -0.011984020471572876, 0.020795010030269623, -0.00436596293002367, 0.029324805364012718, -0.059822287410497665, -0.006844245363026857, -0.07157080620527267, 0.003515383694320917, -0.04621729254722595, -0.012691037729382515, 0.000726577709428966, -0.017685016617178917, 0.0015805793227627873, -0.023699473589658737, 0.02455778792500496, 0.01650182716548443, -0.0005611003725789487, 0.01313735544681549, -0.03697004169225693, 0.011586309410631657, -0.03109750896692276, 0.002269546966999769, 0.05510647967457771, 0.04200093075633049, -0.04021293297410011, 0.01943420059978962, -0.03382987156510353, 0.01674255169928074, 0.0007871782290749252, 0.02546152099967003, -0.05180330201983452, -0.004057280253618956, -0.004152463749051094, 0.025055645033717155, 0.06823547184467316, -0.03512047603726387, -0.029094353318214417, 0.03492109104990959, 0.005731478333473206, 0.006587432697415352, 0.03459044545888901, -0.03234906867146492, -0.030644232407212257, 0.009096716530621052, -0.08383943885564804, -0.004511723294854164, -0.03217020258307457, 0.08778789639472961, -0.02159222960472107, -0.03524763882160187, -0.011535611934959888, -0.017566053196787834, 0.045323580503463745, 0.07528688758611679, 0.04288993403315544, 0.02214275673031807, -0.03047751821577549, -0.09696344286203384, 0.045798372477293015, 0.002663801424205303, 0.013731242157518864, 0.004877877421677113, -8.452023757854477e-05, -0.02171904593706131, -0.07604199647903442, -0.014802533201873302, 0.0434470996260643, 0.08416444808244705, -0.03260587155818939, 0.036947835236787796, -0.020847205072641373, 0.0033680724445730448, -0.0057886880822479725, -0.03761839121580124, -0.034558169543743134, -0.02121296338737011, 0.023352423682808876, -0.045674879103899, 0.011541970074176788, -0.0028149911668151617, -0.019592998549342155, -0.030113007873296738, 0.04479452222585678, -0.02711261250078678, -0.01376986876130104, -0.015137054026126862, 0.03787330165505409, -0.04211140796542168, -0.058868490159511566, 0.022621620446443558, -0.061873678117990494, 0.018635042011737823, 0.0957946702837944, -0.026478828862309456, -0.009100576862692833, 0.02366923913359642, -0.03250204026699066, -0.012457030825316906, -0.008723147213459015, 0.08254920691251755, -0.06095857918262482, -0.018228696659207344, -0.020568063482642174, 0.032965026795864105, 0.027295315638184547, -0.01907704584300518, -0.02482352778315544, -0.02918080799281597, 0.006740565411746502, 0.013976339250802994, 0.02931920811533928, 0.049721263349056244, 0.02334366738796234, 0.0485134981572628, 0.05416290834546089, -0.03416728973388672, 0.0159645676612854, 0.00792902521789074, -0.036309681832790375, -0.016777079552412033, -0.02504665032029152, 0.04007839784026146, -0.019447721540927887, 0.0010675025405362248, -0.00454584788531065, -0.01937537081539631, -0.014088854193687439, -0.024333221837878227, 0.006306167226284742, -0.06680932641029358, 0.06236400455236435, -0.014232086017727852, 0.024508854374289513, 0.009266582317650318, 0.0028097466565668583, -0.018961407244205475, -0.03943360969424248, 0.029250938445329666, 0.009849156253039837, 0.013975447975099087, 0.0045662871561944485, -0.007653113920241594, -0.014280836097896099, 0.024883436039090157, -0.040157053619623184, -0.020544417202472687, 0.030006274580955505, 0.05224647372961044, 0.006253856234252453, 0.06239035353064537, -0.04628833383321762, 0.021818922832608223, 0.0015109688974916935, 0.01681559532880783, 0.061081018298864365, 0.02801625430583954, -0.06620825827121735, 0.006471943575888872, -0.03080269694328308, -0.013683388009667397, -0.05142257362604141, 0.05552705377340317, -0.011017774231731892, -0.05195602402091026, -0.0034073390997946262, -0.008274993859231472, 0.03409573808312416, -0.07048916071653366, 0.008376778103411198, 0.07511857151985168, 0.07715941965579987, 0.04099017754197121, 0.0826466903090477, -0.03628742694854736, 0.03222678601741791, -0.028056997805833817, -0.0015452249208465219, -0.04426915571093559, -0.012381250038743019, 0.0715644359588623, 0.01555804256349802, 0.004714273847639561, -0.040677011013031006, 0.03648185357451439, -0.007235737983137369, 0.003756726859137416, 0.0025328139308840036, -0.036249928176403046, 0.003210110357031226, 0.023850057274103165, 0.03950153663754463, 0.03858254849910736, -0.008479650132358074, 0.018555397167801857, -0.01039097923785448, -0.028874725103378296, 0.035761747509241104, -0.02425226755440235, 0.023784203454852104, -0.0541677325963974, -0.05792344734072685, -0.10181067883968353, 0.03347787633538246, -0.056797973811626434, -0.041634608060121536, -0.024195346981287003, -0.058054666966199875, -0.014956053346395493, 0.01545749045908451, 0.030311373993754387, -0.04090895876288414, -0.004729180596768856, 0.055878203362226486, 0.009167839772999287, 0.008518795482814312, 0.004743565339595079, -0.022774092853069305, -0.03351178392767906, -0.005820485297590494, 0.015929197892546654, -0.019012203440070152, 0.012371324934065342, 0.060729753226041794, -0.021818876266479492, -0.03709878772497177, 0.046148307621479034, -0.08902386575937271, -0.03245120123028755, 0.0302900318056345, 0.030007250607013702, -0.0014949491014704108, -0.07462378591299057, 0.004539735149592161, -0.02697681449353695, -0.011624179780483246, -0.016086064279079437, 0.01459498144686222, -0.03707604855298996, 0.05966360867023468, 0.012377437204122543, -0.03361052647233009, -0.04506048187613487, 0.08588526397943497, 0.0031585474498569965, 0.002622534753754735, 0.07271000742912292, -0.015339331701397896, 0.03216470032930374, 0.0027308459393680096, 0.04112971946597099, 0.0174650140106678, 0.0010120720835402608, -0.06633245199918747, 0.009405240416526794, -0.015627967193722725, 0.018056564033031464, -0.014687965624034405, 0.031039034947752953, 0.03278781473636627, 0.016643505543470383, 0.012311744503676891, -0.045593615621328354, 0.023219583556056023, -0.008363572880625725, -0.02398652769625187, 0.035967495292425156, -0.0009980311151593924, -0.032429903745651245, 0.037544820457696915, -0.0155054721981287, 0.012451197020709515, 0.006394089665263891, -0.07483001053333282, 0.01891157031059265, 0.04167876020073891, 0.016275256872177124, -0.0035872585140168667, -0.0198534969240427, 0.0016779801808297634, 0.006442812737077475, -0.023607369512319565, 0.04420089349150658, 0.015323236584663391, 0.009292948991060257, -0.039923518896102905, 0.05875061824917793, 0.0006734291673637927, 0.0549803152680397, 0.02255793660879135, -0.024417713284492493, 0.0007707964396104217, -0.012504681013524532, 0.0005802894593216479, 0.0047703878954052925, -0.03676341846585274, -0.05662519857287407, -0.008563828654587269, -0.050160687416791916, -0.0017693450208753347, -0.012752828188240528, -0.056930482387542725, -0.018738584592938423, 0.006262694485485554, -6.562928958698807e-33, -0.026133103296160698, -0.012411740608513355, -0.004707302898168564, -0.04692946374416351, -0.048492029309272766, 0.01576176844537258, 0.014301209710538387, -0.02182045951485634, -0.030458692461252213, -0.033470481634140015, 0.0041355774737894535, -0.021374952048063278, 0.003821132704615593, 0.0409032478928566, 0.053710442036390305, 0.054894182831048965, 0.008650426752865314, -0.012939611449837685, -0.03237340599298477, -0.06291016191244125, -0.010501066222786903, -0.011156859807670116, 0.06909599155187607, 0.0754309669137001, 0.03718127682805061, -0.025781406089663506, -0.00872248224914074, -0.023888390511274338, 0.047658536583185196, -0.032022833824157715, -0.017194567248225212, -0.00772559130564332, -0.02372649684548378, -0.06872823089361191, 0.025679562240839005, -0.03635219484567642, -0.032713718712329865, 0.012269425205886364, 0.008874169550836086, -0.012070583179593086, 0.00842951238155365, -0.056665267795324326, -0.014735917560756207, 0.00416806573048234, -0.014901013113558292, -0.05145547538995743, 0.013088174164295197, -0.01126192882657051, 0.030873756855726242, 0.03797854483127594, -0.09080396592617035, 0.0026818616315722466, -0.010729505680501461, 0.07484191656112671, -0.05106111243367195, -0.0088103162124753, 0.00012474773393478245, 0.03348719701170921, -0.04044783487915993, -0.01776072382926941, -0.03831975907087326, 0.05905447155237198, 0.029934803023934364, -0.00608559837564826, -0.038413792848587036, -0.007019016891717911, -0.01460311934351921, 0.04252917692065239, -0.03352588042616844, -0.01743750274181366, 0.03695307672023773, -0.023750003427267075, -0.010766090825200081, 0.04412916675209999, -0.014752417802810669, -0.011831747367978096, -0.013382126577198505, 0.01359772589057684, 0.044289711862802505, 0.01171885896474123, -0.007331639528274536, -0.04945336654782295, -0.017171479761600494, -0.014446225948631763, -0.0016038358444347978, -0.07628800719976425, -0.007104915101081133, 0.02516818232834339, 0.0669017806649208, -0.01621895097196102, -0.0033411819022148848, 0.041184671223163605, -0.03228680044412613, -0.007616915740072727, -0.002626418136060238, 0.06001023203134537, 0.01763257198035717, 0.03619985282421112, -0.02488158829510212, 0.026211505755782127, -0.05446210876107216, -0.008195143193006516, 0.05225639045238495, 0.025479499250650406, 0.025868989527225494, -0.005238804966211319, -0.02985074557363987, -0.025731729343533516, -0.03490491583943367, 0.016855232417583466, 0.003690354758873582, -0.026909325271844864, 0.04619487747550011, -0.007933631539344788, -0.004805902484804392, -0.037755466997623444, 0.02689358964562416, -0.09130208939313889, 0.019848547875881195, -0.01035610493272543, 0.0018966258503496647, -0.005818111822009087, 0.004111635033041239, -0.037084970623254776, -0.02839532494544983, -0.03853388875722885, -0.009053898975253105, -0.058966364711523056, -0.025035517290234566, -0.04142168164253235, 0.04129079729318619, -0.03991333767771721, 3.445637162258208e-07, -0.028302732855081558, 0.039498258382081985, 0.0037857703864574432, -0.012904278002679348, -0.014042106457054615, -0.03803274780511856, -0.055779311805963516, -0.0027984201442450285, 0.03969600424170494, 0.033868636935949326, 0.004653042647987604, -0.027199026197195053, 0.03524652123451233, 4.542777969618328e-05, -0.022195948287844658, -0.09085255116224289, -0.0015283359680324793, 0.011253505013883114, -0.0740833729505539, -0.01934986747801304, 0.05166822671890259, -0.0013857820304110646, 0.12986722588539124, 0.002875738777220249, 0.005362468771636486, 0.018376057967543602, -0.06432956457138062, -0.016640326008200645, 0.015090293250977993, -0.006568337790668011, -0.024381741881370544, 0.006088034249842167, 0.00321559957228601, 0.030171414837241173, -0.031415291130542755, -0.012437775731086731, -0.005147668067365885, 0.09090115129947662, 0.007012775167822838, 0.04537040367722511, -0.0195622518658638, 0.022251605987548828, -0.040795549750328064, -0.026753155514597893, 0.049003716558218, 0.03849544748663902, 0.025461789220571518, 0.06196430325508118, -0.05139118805527687, 0.00977727398276329, -0.0485263392329216, 0.0414995402097702, 0.004883079323917627, 0.009373113512992859, 0.029478738084435463, -0.048096492886543274, -0.011896242387592793, -0.013690060004591942, 0.052820149809122086, -0.03936649113893509, 0.015914225950837135, -0.06888115406036377, 0.038831569254398346, 0.039319079369306564, 0.0823335200548172, -0.03214766085147858, -0.006406970322132111, 3.6085314102105562e-34, 0.021840563043951988, -0.05529802665114403, 0.039259493350982666, -0.041809216141700745, 0.012402662076056004, -0.03438802808523178, -0.030109846964478493, -0.015154792927205563, -0.002456387272104621, 0.023546786978840828, -0.03308180347084999]  # Example vector
    print(ranker(vector))
    